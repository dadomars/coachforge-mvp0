generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DATABASE_DIRECT_URL")
}

model Coach {
  coachId             String   @id @default(cuid()) @map("coach_id")
  email               String   @unique @map("email")
  passwordHash        String   @map("password_hash")
  name                String?  @map("name")
  roundingIncrementKg Float?   @map("rounding_increment_kg")
  createdAt           DateTime @default(now()) @map("created_at")

  athletes     Athlete[]
  competitions Competition[]
  events       Event[]
  exercises    Exercise[]
  sessionTemplates SessionTemplate[]
  assignedSessions AssignedSession[]

  @@map("coach")
}

model Athlete {
  athleteId String @id @default(cuid()) @map("athlete_id")
  coachId   String @map("coach_id")

  firstName String @map("first_name")
  lastName  String @map("last_name")

  notesPublic  String? @map("notes_public")
  notesPrivate String? @map("notes_private")

  createdAt DateTime @default(now()) @map("created_at")

  coach                  Coach                   @relation(fields: [coachId], references: [coachId], onDelete: Cascade)
  auth                   AthleteAuth?
  invites                AthleteInvite[]
  events                 Event[]
  competitions           Competition[]
  competitionAssignments CompetitionAssignment[]
  eventAssignments       EventAssignment[]
  assignedSessions       AssignedSession[]

  @@index([coachId], map: "idx_athlete_coach_id")
  @@map("athlete")
}

model AthleteAuth {
  athleteId       String    @id @map("athlete_id")
  loginIdentifier String    @unique @map("login_identifier") // EMAIL
  passwordHash    String?   @map("password_hash")
  activatedAt     DateTime? @map("activated_at")

  athlete Athlete @relation(fields: [athleteId], references: [athleteId], onDelete: Cascade)

  @@map("athlete_auth")
}

model AthleteInvite {
  inviteId  String @id @default(cuid()) @map("invite_id")
  athleteId String @map("athlete_id")

  tokenHash String    @unique @map("token_hash")
  expiresAt DateTime  @map("expires_at")
  usedAt    DateTime? @map("used_at")
  createdAt DateTime  @default(now()) @map("created_at")

  athlete Athlete @relation(fields: [athleteId], references: [athleteId], onDelete: Cascade)

  @@index([athleteId], map: "idx_invite_athlete_id")
  @@map("athlete_invite")
}

enum EventStatus {
  PLANNED
  DONE
  CANCELLED
}

enum CompetitionType {
  HYROX
  CROSSFIT
  RUN
  ALTRO
}

enum ExerciseCategory {
  WEIGHTLIFTING
  GYM
  METCON
  RUN
  ERG
  ALTRO
}

model Competition {
  competitionId String          @id @default(cuid()) @map("competition_id")
  athleteId     String          @map("athlete_id")
  coachId       String?         @map("coach_id")
  name          String          @map("name")
  dateStart     DateTime        @map("date_start")
  dateEnd       DateTime?       @map("date_end")
  location      String?         @map("location")
  notesPublic   String          @default("") @map("notes_public")
  notesPrivate  String          @default("") @map("notes_private")
  status        EventStatus     @map("status")
  type          CompetitionType @default(ALTRO) @map("type")
  isTarget      Boolean         @default(false) @map("is_target")
  link          String?         @map("link")

  athlete     Athlete                 @relation(fields: [athleteId], references: [athleteId], onDelete: Cascade)
  coach       Coach?                  @relation(fields: [coachId], references: [coachId], onDelete: SetNull)
  assignments CompetitionAssignment[]

  @@index([athleteId], map: "idx_competition_athlete_id")
  @@map("competition")
}

model Event {
  eventId      String      @id @default(cuid()) @map("event_id")
  athleteId    String?     @map("athlete_id")
  coachId      String?     @map("coach_id")
  name         String      @map("name")
  dateStart    DateTime    @map("date_start")
  dateEnd      DateTime?   @map("date_end")
  location     String?     @map("location")
  notesPublic  String      @default("") @map("notes_public")
  notesPrivate String      @default("") @map("notes_private")
  status       EventStatus @map("status")
  typeLabel    String      @map("type_label")
  link         String?     @map("link")

  athlete     Athlete?          @relation(fields: [athleteId], references: [athleteId], onDelete: SetNull)
  coach       Coach?            @relation(fields: [coachId], references: [coachId], onDelete: SetNull)
  assignments EventAssignment[]

  @@index([athleteId], map: "idx_event_athlete_id")
  @@map("event")
}

model Exercise {
  exerciseId   String           @id @default(cuid()) @map("exercise_id")
  coachId      String           @map("coach_id")
  name         String           @map("name")
  category     ExerciseCategory @default(ALTRO) @map("category")
  notesPublic  String           @default("") @map("notes_public")
  notesPrivate String           @default("") @map("notes_private")
  createdAt    DateTime         @default(now()) @map("created_at")
  updatedAt    DateTime         @updatedAt @map("updated_at")

  coach Coach @relation(fields: [coachId], references: [coachId], onDelete: Cascade)
  sessionTemplateRows SessionTemplateExerciseRow[]
  assignedSessionRows AssignedSessionRow[]

  @@unique([coachId, name], map: "uq_exercise_coach_name")
  @@index([coachId], map: "idx_exercise_coach_id")
  @@index([name], map: "idx_exercise_name")
  @@map("exercise")
}

model SessionTemplate {
  sessionTemplateId String   @id @default(cuid()) @map("session_template_id")
  coachId           String   @map("coach_id")
  title             String   @map("title")
  notesPublic       String   @default("") @map("notes_public")
  notesPrivate      String   @default("") @map("notes_private")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  coach  Coach                  @relation(fields: [coachId], references: [coachId], onDelete: Cascade)
  blocks SessionTemplateBlock[]
  assignedSessions AssignedSession[]

  @@index([coachId], map: "idx_session_template_coach_id")
  @@map("session_template")
}

model SessionTemplateBlock {
  blockId           String @id @default(cuid()) @map("block_id")
  sessionTemplateId String @map("session_template_id")
  name              String @map("name")
  sortOrder         Int    @map("sort_order")

  template SessionTemplate             @relation(fields: [sessionTemplateId], references: [sessionTemplateId], onDelete: Cascade)
  rows     SessionTemplateExerciseRow[]

  @@index([sessionTemplateId], map: "idx_session_template_block_template_id")
  @@index([sortOrder], map: "idx_session_template_block_sort_order")
  @@map("session_template_block")
}

model SessionTemplateExerciseRow {
  rowId      String  @id @default(cuid()) @map("row_id")
  blockId    String  @map("block_id")
  exerciseId String  @map("exercise_id")
  sortOrder  Int     @map("sort_order")
  sets       String? @map("sets")
  reps       String? @map("reps")
  rest       String? @map("rest")
  percent    Float?  @map("percent")
  kg         Float?  @map("kg")
  notesPublic  String? @map("notes_public")
  notesPrivate String? @map("notes_private")

  block    SessionTemplateBlock @relation(fields: [blockId], references: [blockId], onDelete: Cascade)
  exercise Exercise             @relation(fields: [exerciseId], references: [exerciseId], onDelete: Cascade)

  @@index([blockId], map: "idx_session_template_row_block_id")
  @@index([exerciseId], map: "idx_session_template_row_exercise_id")
  @@index([sortOrder], map: "idx_session_template_row_sort_order")
  @@map("session_template_row")
}

model AssignedSession {
  assignedSessionId String   @id @default(cuid()) @map("assigned_session_id")
  coachId           String   @map("coach_id")
  athleteId         String   @map("athlete_id")
  templateId        String?  @map("template_id")
  date              DateTime @map("date")
  title             String   @map("title")
  notesPublic       String   @default("") @map("notes_public")
  notesPrivate      String   @default("") @map("notes_private")
  status            EventStatus @default(PLANNED) @map("status")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  coach     Coach          @relation(fields: [coachId], references: [coachId], onDelete: Cascade)
  athlete   Athlete        @relation(fields: [athleteId], references: [athleteId], onDelete: Cascade)
  template  SessionTemplate? @relation(fields: [templateId], references: [sessionTemplateId], onDelete: SetNull)
  blocks    AssignedSessionBlock[]

  @@index([athleteId, date], map: "idx_assigned_session_athlete_date")
  @@index([coachId], map: "idx_assigned_session_coach_id")
  @@index([athleteId], map: "idx_assigned_session_athlete_id")
  @@index([date], map: "idx_assigned_session_date")
  @@map("assigned_session")
}

model AssignedSessionBlock {
  blockId           String @id @default(cuid()) @map("block_id")
  assignedSessionId String @map("assigned_session_id")
  name              String @map("name")
  sortOrder         Int    @map("sort_order")

  session AssignedSession @relation(fields: [assignedSessionId], references: [assignedSessionId], onDelete: Cascade)
  rows    AssignedSessionRow[]

  @@map("assigned_session_block")
}

model AssignedSessionRow {
  rowId      String  @id @default(cuid()) @map("row_id")
  blockId    String  @map("block_id")
  exerciseId String  @map("exercise_id")
  sortOrder  Int     @map("sort_order")
  sets       String? @map("sets")
  reps       String? @map("reps")
  rest       String? @map("rest")
  percent    Float?  @map("percent")
  kg         Float?  @map("kg")
  notesPublic  String? @map("notes_public")
  notesPrivate String? @map("notes_private")

  block    AssignedSessionBlock @relation(fields: [blockId], references: [blockId], onDelete: Cascade)
  exercise Exercise             @relation(fields: [exerciseId], references: [exerciseId], onDelete: Cascade)

  @@map("assigned_session_row")
}

model CompetitionAssignment {
  assignmentId  String   @id @default(cuid()) @map("assignment_id")
  athleteId     String   @map("athlete_id")
  competitionId String   @map("competition_id")
  isTarget      Boolean  @default(false) @map("is_target")
  assignedAt    DateTime @default(now()) @map("assigned_at")

  athlete     Athlete     @relation(fields: [athleteId], references: [athleteId], onDelete: Cascade)
  competition Competition @relation(fields: [competitionId], references: [competitionId], onDelete: Cascade)

  @@unique([athleteId, competitionId], map: "uq_competition_assignment_athlete_competition")
  @@index([athleteId], map: "idx_competition_assignment_athlete_id")
  @@index([competitionId], map: "idx_competition_assignment_competition_id")
  @@map("competition_assignment")
}

model EventAssignment {
  assignmentId String   @id @default(cuid()) @map("assignment_id")
  athleteId    String   @map("athlete_id")
  eventId      String   @map("event_id")
  assignedAt   DateTime @default(now()) @map("assigned_at")

  athlete Athlete @relation(fields: [athleteId], references: [athleteId], onDelete: Cascade)
  event   Event   @relation(fields: [eventId], references: [eventId], onDelete: Cascade)

  @@unique([athleteId, eventId], map: "uq_event_assignment_athlete_event")
  @@index([athleteId], map: "idx_event_assignment_athlete_id")
  @@index([eventId], map: "idx_event_assignment_event_id")
  @@map("event_assignment")
}
